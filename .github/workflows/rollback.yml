name: Rollback

on:
  # ‚îÄ‚îÄ D√©clenchement manuel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  workflow_dispatch:
    inputs:
      version:
        description: "Version vers laquelle revenir (ex: 1.2.3). Laisser vide pour revenir √† la version pr√©c√©dente."
        required: false
        default: ""
      reason:
        description: "Raison du rollback"
        required: true
        default: "R√©gression d√©tect√©e en production"

  # ‚îÄ‚îÄ D√©clenchement automatique depuis recover.yml ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  workflow_call:
    inputs:
      version:
        description: "Version cible du rollback"
        required: false
        type: string
        default: ""
      reason:
        description: "Raison du rollback"
        required: false
        type: string
        default: "Auto-recovery"
    secrets:
      GITHUB_TOKEN:
        required: false
      DISCORD_WEBHOOK_URL:
        required: false

jobs:
  rollback:
    name: Rollback vers ${{ inputs.version || 'version pr√©c√©dente' }}
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Resolve target version
        id: target
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "REPO_LOWER=$REPO_LOWER" >> "$GITHUB_OUTPUT"

          if [ -n "${{ inputs.version }}" ]; then
            # Version explicitement fournie
            TARGET="${{ inputs.version }}"
            echo "üéØ Version cible fournie : $TARGET"
          else
            # R√©cup√®re l'avant-derni√®re release GitHub (= version pr√©c√©dente)
            TARGET=$(gh release list --limit 10 --json tagName,isLatest \
              | jq -r '[.[] | select(.isLatest == false)] | .[0].tagName // empty' \
              | sed 's/^v//')
            echo "üîç Derni√®re version stable d√©tect√©e : $TARGET"
          fi

          if [ -z "$TARGET" ]; then
            echo "‚ùå Impossible de d√©terminer la version cible"
            exit 1
          fi

          echo "VERSION=$TARGET" >> "$GITHUB_OUTPUT"
          echo "IMAGE=ghcr.io/${REPO_LOWER}:${TARGET}" >> "$GITHUB_OUTPUT"
          echo "TAG=v${TARGET}" >> "$GITHUB_OUTPUT"

      - name: Log into GitHub Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify target image exists on GHCR
        run: |
          echo "üîç V√©rification de l'image : ${{ steps.target.outputs.IMAGE }}"
          docker pull "${{ steps.target.outputs.IMAGE }}"
          echo "‚úÖ Image disponible"

      - name: Smoke test the rollback image
        run: |
          docker run -d --name rollback-check -p 3001:3000 \
            "${{ steps.target.outputs.IMAGE }}"
          timeout 30 bash -c 'until curl -sf http://localhost:3001/health; do sleep 1; done'
          HTTP=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:3001/health)
          docker stop rollback-check && docker rm rollback-check
          if [ "$HTTP" != "200" ]; then
            echo "‚ùå L'image de rollback ne passe pas le smoke test (HTTP $HTTP)"
            exit 1
          fi
          echo "‚úÖ Image de rollback valid√©e (HTTP $HTTP)"

      - name: Re-tag image as latest on GHCR
        run: |
          REPO_LOWER="${{ steps.target.outputs.REPO_LOWER }}"
          docker tag "${{ steps.target.outputs.IMAGE }}" \
            "ghcr.io/${REPO_LOWER}:latest"
          docker push "ghcr.io/${REPO_LOWER}:latest"
          echo "‚úÖ Tag :latest mis √† jour ‚Üí ${{ steps.target.outputs.VERSION }}"

      - name: Trigger Vercel redeploy via webhook
        if: vars.VERCEL_DEPLOY_HOOK != ''
        run: |
          HTTP=$(curl -sf -o /dev/null -w "%{http_code}" \
            -X POST "${{ vars.VERCEL_DEPLOY_HOOK }}")
          echo "Vercel deploy hook ‚Üí HTTP $HTTP"

      - name: Wait for production to reflect rollback
        if: vars.PRODUCTION_URL != ''
        run: |
          echo "‚è≥ En attente du d√©ploiement Vercel..."
          timeout 120 bash -c \
            'until curl -sf ${{ vars.PRODUCTION_URL }}/health; do sleep 5; done'
          echo "‚úÖ Production op√©rationnelle apr√®s rollback"

      - name: Mark rollback version as latest GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release edit "${{ steps.target.outputs.TAG }}" --latest
          echo "‚úÖ Release ${{ steps.target.outputs.TAG }} marqu√©e comme latest"

      - name: Notify Discord ‚Äì Rollback effectu√©
        if: secrets.DISCORD_WEBHOOK_URL != ''
        uses: tsickert/discord-webhook@v6.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-color: 16776960
          embed-title: "‚è™ Rollback effectu√© ‚Äî ${{ github.repository }}"
          embed-description: |
            **Version restaur√©e :** `${{ steps.target.outputs.VERSION }}`
            **Image :** `${{ steps.target.outputs.IMAGE }}`
            **Raison :** `${{ inputs.reason }}`
            **D√©clench√© par :** `${{ github.actor }}`
            ‚û°Ô∏è **[Voir le run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})**
