name: ðŸ”™ Rollback

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version cible du rollback (ex: 1.2.0)"
        required: true
        type: string

jobs:
  rollback:
    name: Rollback to v${{ inputs.version }}
    runs-on: ubuntu-latest

    permissions:
      packages: write

    env:
      IMAGE_BASE: ghcr.io/${{ github.repository }}

    steps:
      # â”€â”€ Connexion au registre â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Log into GitHub Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ VÃ©rifier que l'image cible existe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify target image exists
        run: |
          REPO_LOWER=$(echo "$IMAGE_BASE" | tr '[:upper:]' '[:lower:]')
          echo "ðŸ” VÃ©rification de l'image : ${REPO_LOWER}:${{ inputs.version }}"
          docker manifest inspect "${REPO_LOWER}:${{ inputs.version }}" > /dev/null 2>&1 \
            || { echo "âŒ L'image ${REPO_LOWER}:${{ inputs.version }} n'existe pas dans le registre."; exit 1; }
          echo "âœ… Image trouvÃ©e."

      # â”€â”€ Re-tag de l'image cible en latest â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Re-tag target version as latest
        run: |
          REPO_LOWER=$(echo "$IMAGE_BASE" | tr '[:upper:]' '[:lower:]')
          echo "ðŸ“¦ Pull de l'image ${REPO_LOWER}:${{ inputs.version }}"
          docker pull "${REPO_LOWER}:${{ inputs.version }}"

          echo "ðŸ·ï¸  Re-tag en latest"
          docker tag "${REPO_LOWER}:${{ inputs.version }}" "${REPO_LOWER}:latest"

          echo "ðŸš€ Push de ${REPO_LOWER}:latest"
          docker push "${REPO_LOWER}:latest"

      # â”€â”€ RÃ©sumÃ© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Rollback summary
        run: |
          REPO_LOWER=$(echo "$IMAGE_BASE" | tr '[:upper:]' '[:lower:]')
          echo "## âœ… Rollback effectuÃ©" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| ParamÃ¨tre | Valeur |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Version cible** | \`${{ inputs.version }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Image re-taguÃ©e** | \`${REPO_LOWER}:latest\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **DÃ©clenchÃ© par** | \`${{ github.actor }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Date** | \`$(date -u +'%Y-%m-%d %H:%M:%S UTC')\` |" >> "$GITHUB_STEP_SUMMARY"
