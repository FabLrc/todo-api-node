
#
# Pour bloquer les merges vers main / develop tant que le workflow
# n'est pas terminÃ©, activez dans Settings > Branches > Branch
# protection rules :
#   âœ… Require status checks to pass before merging
#   âœ… Cochez Â« Quality Checks Â» dans la liste des checks requis
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - "feature/**"
      - "release/**"
  pull_request:
    branches:
      - main
      - develop

# Annule les exÃ©cutions prÃ©cÃ©dentes sur la mÃªme branche / PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# JOB 1 â€“ Quality Checks (tests, lint, audit, sonar)
# DÃ©clenchÃ© sur TOUTES les branches + PRs vers main / develop
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 requis pour SonarCloud (analyse de blame / PR diff)
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npx eslint .

      - name: Security audit (npm audit)
        run: npm audit --audit-level=moderate

      - name: Run tests with coverage
        run: npm test
        env:
          NODE_ENV: test

      # â”€â”€ SonarCloud â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ExÃ©cutÃ© uniquement sur main, develop et les PRs ciblant
      # ces branches. Les feature branches n'en ont pas besoin.
      #
      # PrÃ©â€‘requis :
      #   1. CrÃ©ez le projet sur https://sonarcloud.io
      #   2. Ajoutez le secret SONAR_TOKEN dans GitHub
      #      (Settings > Secrets and variables > Actions)
      #   3. Remplacez les valeurs <VOTRE_ORG> et <VOTRE_PROJECT>
      #      ci-dessous par celles de votre projet SonarCloud.
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: SonarCloud Scan
        if: |
          github.ref == 'refs/heads/main'
          || github.ref == 'refs/heads/develop'
          || github.event_name == 'pull_request'
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ vars.SONAR_ORG }}
            -Dsonar.projectKey=${{ vars.SONAR_PROJECT_KEY }}
            -Dsonar.sources=.
            -Dsonar.exclusions=coverage/**,node_modules/**,tests/**
            -Dsonar.tests=tests
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2 â€“ Release (Docker build/push + GitHub Release)
  # DÃ©clenchÃ© UNIQUEMENT sur les branches release/x.y.z
  # NÃ©cessite que le job quality soit passÃ© au vert.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    name: Release â€“ Docker & GitHub Release
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release/')
    needs: quality
    runs-on: ubuntu-latest

    permissions:
      contents: write   # pour crÃ©er le tag + la release
      packages: write   # pour push vers ghcr.io

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from branch name
        id: version
        run: |
          BRANCH="${{ github.ref_name }}"
          VERSION="${BRANCH#release/}"
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "VERSION=$VERSION"       >> "$GITHUB_OUTPUT"
          echo "REPO_LOWER=$REPO_LOWER" >> "$GITHUB_OUTPUT"
          echo "ðŸ·ï¸  Version dÃ©tectÃ©e : $VERSION"

      - name: Log into GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: |
            ghcr.io/${{ steps.version.outputs.REPO_LOWER }}:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ steps.version.outputs.REPO_LOWER }}:latest

      - name: Create or update Git tag
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f "v${{ steps.version.outputs.VERSION }}"
          git push origin "v${{ steps.version.outputs.VERSION }}" --force

      - name: Create or update GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ steps.version.outputs.VERSION }}"
          IMAGE="ghcr.io/${{ steps.version.outputs.REPO_LOWER }}:${{ steps.version.outputs.VERSION }}"

          NOTES="## Release ${TAG}

          **Image Docker :**
          \`\`\`
          docker pull ${IMAGE}
          \`\`\`

          **DÃ©ployÃ© automatiquement sur Vercel.**"

          if gh release view "$TAG" > /dev/null 2>&1; then
            gh release edit "$TAG" \
              --title "Release $TAG" \
              --notes "$NOTES" \
              --latest
          else
            gh release create "$TAG" \
              --title "Release $TAG" \
              --notes "$NOTES" \
              --latest
          fi
