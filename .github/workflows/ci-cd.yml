name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - "feature/**"
      - "release/**"
  pull_request:
    branches:
      - main
      - develop
  # ── Déclenchement manuel (recovery / redéploiement forcé) ──────
  workflow_dispatch:
    inputs:
      reason:
        description: "Raison du déclenchement manuel"
        required: false
        default: "Redéploiement manuel"
      node-versions:
        description: 'Versions Node.js à tester (JSON array)'
        required: false
        default: '["18", "20", "22"]'

# Annule les exécutions précédentes sur la même branche / PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ──────────────────────────────────────────────────────────────
  # JOB 1 – Quality Checks (tests, lint, audit, sonar)
  # Appelle le workflow réutilisable quality.yml
  # ──────────────────────────────────────────────────────────────
  quality:
    uses: ./.github/workflows/quality.yml
    with:
      node-versions: ${{ inputs.node-versions || '["18", "20", "22"]' }}
    secrets: inherit

  # ──────────────────────────────────────────────────────────────
  # JOB 2 – Release (Docker build/push + GitHub Release)
  # Déclenché UNIQUEMENT sur les branches release/x.y.z
  # Appelle le workflow réutilisable release.yml
  # ──────────────────────────────────────────────────────────────
  release:
    needs: quality
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release/')
    uses: ./.github/workflows/release.yml
    secrets: inherit
    permissions:
      contents: write
      packages: write

  # ──────────────────────────────────────────────────────────────
  # JOB 3 – Discord Notification
  # Déclenché après quality (et release si applicable).
  # S'exécute TOUJOURS (succès, échec ou annulation).
  # Appelle le workflow réutilisable notify.yml
  # ──────────────────────────────────────────────────────────────
  notify:
    needs: [quality, release]
    if: always() && needs.quality.result != 'skipped'
    uses: ./.github/workflows/notify.yml
    with:
      quality-result: ${{ needs.quality.result }}
      release-result: ${{ needs.release.result }}
    secrets: inherit
