# Déclenché sur push vers main (merge depuis release)
# Déploie l'image Docker sur un serveur via SSH.
#
# Secrets GitHub requis (Settings > Secrets > Actions) :
#   DEPLOY_HOST       – IP ou domaine du serveur
#   DEPLOY_USER       – utilisateur SSH (ex: ubuntu)
#   DEPLOY_SSH_KEY    – clé privée SSH (contenu du fichier id_rsa)
#   SECRET_KEY        – clé secrète applicative
#   API_KEY           – clé API applicative

name: Main – Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get latest version tag
        id: version
        run: |
          git fetch --tags
          VERSION=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n1)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Déploiement de la version : $VERSION"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker pull ghcr.io/${{ github.repository }}:${{ steps.version.outputs.VERSION }}
            docker stop todo-api || true
            docker rm todo-api || true
            docker run -d \
              --name todo-api \
              --restart unless-stopped \
              -p 3000:3000 \
              -e NODE_ENV=production \
              -e SECRET_KEY=${{ secrets.SECRET_KEY }} \
              -e API_KEY=${{ secrets.API_KEY }} \
              ghcr.io/${{ github.repository }}:${{ steps.version.outputs.VERSION }}
