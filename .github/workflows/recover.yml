name: Auto-Recovery

on:
  # â”€â”€ VÃ©rification pÃ©riodique de la santÃ© de la prod â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  schedule:
    - cron: "*/30 * * * *"   # toutes les 30 minutes

  # â”€â”€ DÃ©clenchement manuel (rollback ou re-dÃ©ploiement forcÃ©) â”€â”€â”€
  workflow_dispatch:
    inputs:
      action:
        description: "Action Ã  effectuer"
        required: true
        type: choice
        options:
          - health-check
          - redeploy-latest
          - rollback
        default: health-check
      version:
        description: "Version cible pour le rollback (ex: 1.2.3)"
        required: false
        default: ""
      reason:
        description: "Raison de l'intervention manuelle"
        required: false
        default: "Intervention manuelle"

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1 â€“ Health Check production
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  health-check:
    name: Production Health Check
    runs-on: ubuntu-latest
    outputs:
      healthy: ${{ steps.check.outputs.healthy }}

    steps:
      - name: Check production health endpoint
        id: check
        run: |
          HTTP_CODE=$(curl -sf -o /tmp/health.json -w "%{http_code}" \
            "${{ vars.PRODUCTION_URL }}/health" || echo "000")

          echo "HTTP status : $HTTP_CODE"

          if [ "$HTTP_CODE" = "200" ]; then
            DB_STATUS=$(cat /tmp/health.json | grep -o '"db":"[^"]*"' | cut -d'"' -f4 || echo "unknown")
            echo "DB status : $DB_STATUS"
            if [ "$DB_STATUS" = "ok" ] || [ "$DB_STATUS" = "unknown" ]; then
              echo "healthy=true" >> "$GITHUB_OUTPUT"
              echo "âœ… Production saine"
            else
              echo "healthy=false" >> "$GITHUB_OUTPUT"
              echo "âŒ Production : DB en erreur ($DB_STATUS)"
            fi
          else
            echo "healthy=false" >> "$GITHUB_OUTPUT"
            echo "âŒ Production indisponible (HTTP $HTTP_CODE)"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2 â€“ Recovery automatique
  # DÃ©clenchÃ© si la prod est malsaine OU si workflow_dispatch
  # demande redeploy-latest / rollback
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  recover:
    name: Auto-Recovery
    needs: health-check
    runs-on: ubuntu-latest
    if: |
      needs.health-check.outputs.healthy == 'false'
      || (github.event_name == 'workflow_dispatch'
          && inputs.action != 'health-check')

    permissions:
      packages: read

    steps:
      - name: Determine target version
        id: target
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] \
             && [ "${{ inputs.action }}" = "rollback" ] \
             && [ -n "${{ inputs.version }}" ]; then
            echo "VERSION=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
            echo "ACTION=rollback vers ${{ inputs.version }}"
          else
            echo "VERSION=latest" >> "$GITHUB_OUTPUT"
            echo "ACTION=redÃ©ploiement de latest"
          fi

      - name: Log into GitHub Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull & verify target image
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          # Utilise :previous si pas de version explicite, sinon la version demandÃ©e
          if [ -n "${{ inputs.version }}" ]; then
            IMAGE="ghcr.io/${REPO_LOWER}:${{ inputs.version }}"
          else
            IMAGE="ghcr.io/${REPO_LOWER}:previous"
          fi
          echo "IMAGE=$IMAGE" >> "$GITHUB_ENV"
          docker pull "$IMAGE"
          echo "âœ… Image $IMAGE disponible"

      - name: Smoke test the recovery image
        run: |
          docker run -d --name recovery-check -p 3001:3000 "$IMAGE"
          timeout 30 bash -c 'until curl -sf http://localhost:3001/health; do sleep 1; done'
          HTTP=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:3001/health)
          docker stop recovery-check && docker rm recovery-check
          if [ "$HTTP" != "200" ]; then
            echo "âŒ L'image de recovery ne rÃ©pond pas correctement"
            exit 1
          fi
          echo "âœ… Image de recovery validÃ©e"

      - name: Trigger Vercel redeploy via webhook
        if: vars.VERCEL_DEPLOY_HOOK != ''
        run: |
          HTTP=$(curl -sf -o /dev/null -w "%{http_code}" \
            -X POST "${{ vars.VERCEL_DEPLOY_HOOK }}")
          echo "Vercel deploy hook â†’ HTTP $HTTP"
          if [ "$HTTP" != "200" ] && [ "$HTTP" != "201" ]; then
            echo "âš ï¸  Le hook Vercel a retournÃ© HTTP $HTTP"
          fi

      - name: Wait for production to recover
        run: |
          echo "En attente de la rÃ©cupÃ©ration de la production..."
          timeout 120 bash -c \
            'until curl -sf ${{ vars.PRODUCTION_URL }}/health; do sleep 5; done'
          echo "âœ… Production de nouveau opÃ©rationnelle"

      - name: Notify Discord â€“ Recovery
        uses: tsickert/discord-webhook@v6.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-color: 3066993
          embed-title: "ğŸ”„ Auto-Recovery dÃ©clenchÃ© â€” ${{ github.repository }}"
          embed-description: |
            **Action :** `${{ steps.target.outputs.ACTION || inputs.action }}`
            **Raison :** `${{ inputs.reason || 'Health check automatique en Ã©chec' }}`
            **Image :** `${{ env.IMAGE }}`
            **DÃ©clenchÃ© par :** `${{ github.actor }}`
            â¡ï¸ **[Voir le run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})**

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3 â€“ Notification si prod toujours saine (schedule uniquement)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify-healthy:
    name: Notify â€“ Production saine
    needs: health-check
    runs-on: ubuntu-latest
    if: |
      needs.health-check.outputs.healthy == 'true'
      && github.event_name == 'workflow_dispatch'
      && inputs.action == 'health-check'

    steps:
      - name: Notify Discord â€“ Healthy
        uses: tsickert/discord-webhook@v6.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-color: 3066993
          embed-title: "âœ… Production saine â€” ${{ github.repository }}"
          embed-description: |
            **URL :** `${{ vars.PRODUCTION_URL }}`
            **DÃ©clenchÃ© par :** `${{ github.actor }}`
            **Raison :** `${{ inputs.reason }}`
